---
title: 'Alveolar Macrophages after Murine Lung Transplant '
author: '180166459'
date: "2/8/2021"
output:
  word_document: default
---
```{r echo = FALSE, eval = FALSE}
version #check version of RStudio - this is relevant for packages 
```

```{r setup, include=FALSE}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo = FALSE, eval = FALSE}
#Clear Workspace
rm(list = ls(all.names = TRUE)) # clear all objects includes hidden objects.
gc() #frees up memory and reports the memory usage
```

## R Markdown

# **BMS353**

# **Bioinformatics**

**Alveolar Macrophages after Murine Lung Transplant -
(mouse)**

FOR NOT INCLUDING R CODE IN REPORT: {r echo = FALSE}
FOR NOT INCLUDING OUTPUT/CONSOLE PRINT in REPORT: {r eval = FALSE}

This is an R Markdown document. Markdown is a simple formatting syntax.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


**INTRODUCTION**

! [Alt text] (Users\Andr\Documents\BMS353-Alveolar-Macrophages---RNA-seq-dataset\images\image1macrophages.jpg)

In this report we will analyze data for a research study that covers the following topic: Alveolar Macrophages after Murine Lung Transplant. For this we have the following resources provided:

[GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE116583)

[Google drive](https://drive.google.com/drive/folders/1AqYi0Ps5t5xo6XYWXjOtO6eDOMpT1ADE) - Google drive folder with the following content:

* meta_data
* salmon-quant.sf files
* tx2gene.csv


The project name BMS353-Alveolar-Macrophages---RNA-seq-dataset with all files and the code are available on github in a repository:

[Github](https://github.com/IoanaAndra/BMS353-Alveolar-Macrophages---RNA-seq-dataset)


In order to use the necessary functions and analyze the data, we use some packages available in R:

* readr
* ggplot2
* dplyr

Every chunk of code can be name like this:
```{r Name_of_chunk_here}

```

Installing packages in R

```{r eval = FALSE, tidy =FALSE}
#SECTION FOR PACKAGES
#installing all necessary packages
# IF using same R version (4.0.3) and have all packages installed already, all lines of this section can remain commented 

 
# install.packages("readr")
# install.packages("ggplot2")
# install.packages("dplyr")
# install.packages("learnr")
# install.packages("stringi")
# install.packages("tidyverse")

if (!requireNamespace("BiocManager", quietly = TRUE))     # installing tximport
    install.packages("BiocManager")
# 
# BiocManager::install("tximport")

install.packages("jsonlite")
# BiocManager::install("GenomicFeatures")



install.packages() #check isntalled packages. This can be seen also in Packages tab

old.packages() 

# update.packages(ask = FALSE) #update installed packages without asking permission from user

```

Reading tx2gene file using read.csv()

With head, we display first rows of data
```{r Read tx2gene.csv, tidy =FALSE, collapse = FALSE} 
library(readr)
tx2GeneFile <- read.csv(file = 'tx2gene.csv')
head(tx2GeneFile)
#view(tx2GeneFile)
```



We are going to display tx2gene.csv

```{r tidy =FALSE, collapse = FALSE}

library(readr) #package used to import spreadsheets in R

dataPath <- "tx2gene.csv" #asigning value which represent path of file

file.exists(dataPath) #file.exists() return TRUE id file can be found or FALSE if it is not found


dataGenes <- read.csv(dataPath) #storing content of csv file into variable data_genes



#check data frame that we created

 # testData <- read_table(dataGenes) ##*******Error: `file` must be a string, raw vector or a connection.
# 
# View(test)  #view() - invoking a spreadsheet style data viewer nb
# 
# 
# head(dataGenes)

```

**ANALYSIS**


```{r tidy =FALSE, collapse = FALSE}


library(tximport)
library(readr)
library(dplyr)
# Read the sample information into R
sampleinfo <- read.delim("meta_data/sampleInfo.txt")
View(sampleinfo)    # view sampleinfo.txt in a new tab
#glimpse(sampleinfo)
sampleinfo


rownames(sampleinfo) <- sampleinfo$run 

dirs <- list.files("salmon_quant/")
quant_files <- list.files("salmon_quant/",pattern="quant.sf",recursive = TRUE,full.names = TRUE)
#names(quant_files) <- dirs
quant_files

# tx2gene links transcript IDs to gene IDs for summarization
tx2geneVariable <- read.csv("tx2gene.csv")

txi <- tximport(files=quant_files, type="salmon", tx2gene=tx2geneVariable)

View(txi)  #view txi in a new tab

#inspect salmon output (quant.sf files)
quants <- read_tsv(quant_files[1])
head(quants)

 # spec(quants)
 
 filter(quants, quants$TPM ==0) #filter data where TPM = 0
#print.data.frame(quants) #print quants, maximum output to print in console 200 lines
 
tail(quants, n = 3)

max(quants$TPM)


 
```


After asigning to quants variable the files


```{r tidy = FALSE, collapse = FALSE}
rpk <- quants$NumReads / quants$EffectiveLength
scale_factor <- sum(rpk) / 1e6
tpm <- rpk / scale_factor

#define transcript mapping

gtf_file <- "Mus_musculus.GRCm38.91.chr.gtf.gz"
file.exists(gtf_file)

download.file("ftp://ftp.ensembl.org/pub/release-91/gtf/mus_musculus/Mus_musculus.GRCm38.91.chr.gtf.gz",destfile = gtf_file) #gtf based on organism of interest

# create a database of transcripts
# Could take a few minutes to run the makeTxDbFromGFF command
library(GenomicFeatures)
txdb <- makeTxDbFromGFF(gtf_file)


#specify number of keys and columns

keytypes(txdb)
columns(txdb)

#get names for all transcripts - using keys function
#compose query - using select function - this will return data frame

k <- keys(txdb, keytype="TXNAME")
tx_map <- select(txdb, keys = k, columns="GENEID", keytype = "TXNAME")

#visualise first rows of the transcript map
head(tx_map)
```



``` {r eval = FALSE, tidy = FALSE}
#use tximport package

library(tximport)
tx2gene <- tx_map
# write.csv(tx2gene,file="tx2gene.csv",row.names = FALSE,quote=FALSE)
txi <- tximport(quant_files,type="salmon",tx2gene = tx2gene)

table(tx_map$TXNAME %in% quants$Name)

tx2gene <- tx_map
txi <- tximport(quant_files,type="salmon",tx2gene = tx2gene,ignoreTxVersion = TRUE)

names(txi)

head(txi$counts) #displays 

all(rownames(sampleinfo) == colnames(txi$counts))

library(tidyr)

quants <- separate(quants, Name, c("TXNAME","Number"),remove = FALSE)
head(quants)
#ERRORTEXT:  Expected 2 pieces. Missing pieces filled with `NA` in 132374 rows [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, ...].Error in left_join(quants, tx_map, by = "TXNAME") : 
#   could not find function "left_join"


#commented code below
# quants <- left_join(quants, tx_map, by="TXNAME")
# head(quants)
# 
# tx2gene <- dplyr:::select(quants, Name, GENEID)
# head(tx2gene)
# 
# any(is.na(tx2gene$GENEID))
# 
# tx2gene <- filter(tx2gene, !is.na(GENEID))
# 
# library(tximport)
# txi <- tximport(quant_files,type="salmon",tx2gene = tx2gene)
```




```{r}

```



**CONCLUSIONS**





*References*
